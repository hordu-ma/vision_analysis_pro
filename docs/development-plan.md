# Vision Analysis Pro 开发计划（系统版）

本计划面向“工程基础设施图像识别智能运维系统（无人机巡检 + YOLO 检测）”，以 12 周交付可试点的端到端方案为目标：从数据与训练、推理与 API、边缘 Agent，到性能优化与生产化能力。

本文档只回答“要做什么、何时做、做到什么算完成”；项目当前进度与变更记录请参见 `docs/progress.md`。

**当前进度快照（截至 2025-12-17）**

- 后端 M1 闭环完成：YOLO 训练脚本、真实推理引擎、API 上传与可视化、78 passed / 2 skipped，ruff 全绿。
- 前端 Web MVP 完成：Vue3 + TS 页面闭环（上传 → 推理 → 展示）、路径别名与 ESLint/TS 告警清零、vitest 19/19 通过、前端文档更新。
- 待办优先级（前端）：统一错误处理（axios 拦截器 + 全局提示 + 错误边界）、体验优化（加载/进度/缩放/快捷键）、Pinia 取舍、Element Plus 按需与生产构建/预览。

---

## 1. 目标与成功标准

### 1.1 业务目标

- 支持无人机图像/视频巡检场景，对裂缝、锈蚀、变形等缺陷进行检测并输出结构化结果。
- 支持云端服务（FastAPI）与边缘侧执行（Jetson/NUC 等）两种部署形态。

### 1.2 交付目标（12 周）

- 可复现的训练与导出流水线（YOLO 训练 + ONNX 导出）。
- 可运行的推理引擎（Python 基线 + 可选加速后端）。
- 可对外提供的 HTTP API（健康检查、图片推理；后续扩展视频/批量）。
- 可最小可用的边缘 Agent（采集/推理/上报/缓存）。
- 具备基础工程化（测试、lint、容器化、观测性）。

### 1.3 成功标准（验收维度）

- **功能闭环**：上传图片 → 得到检测结果 JSON（含 bbox/label/score）→ 可选返回可视化图。
- **可复现**：从数据配置到训练、导出、推理可一键跑通（脚本/命令明确）。
- **稳定性**：关键错误路径可预期（模型缺失、依赖缺失、空文件等）。
- **质量门槛**：`ruff` 无错误；`pytest` 通过；M1 覆盖率目标 ≥ 60%（核心路径）。

---

## 2. 范围与非目标

### 2.1 范围（本项目做什么）

- 检测任务：缺陷/隐患目标检测（YOLO 系列），输出结构化检测结果。
- 输入形式：图片为主；视频流/批量为后续阶段。
- 系统形态：云端 API + 边缘 Agent（先 Python，后 Rust/加速）。
- 可选性能路线：ONNX Runtime / TensorRT（与平台适配相关）。

### 2.2 非目标（本阶段不做或不承诺）

- 不承诺一开始就具备完整的“设备管理/模型市场/多租户”等平台能力（M3 之后再做）。
- 不把 Rust 路线作为 M1 的关键路径（M1 必须纯 Python 可用）。
- 不在缺少数据与标注规范的情况下承诺高精度指标；精度以数据与验收集为准。

---

## 3. 角色与典型使用场景

- **巡检人员**：上传现场图片/视频，查看检测结果与可视化。
- **运维/工程师**：在边缘设备上运行 Agent，自动采集与上报结果。
- **算法工程师**：迭代数据集、训练与导出模型，评估效果并发布模型版本。

---

## 4. 现状与差距（基于仓库当前内容）

### 4.1 已具备

- Python 代码骨架：`core/inference`、`core/preprocessing`、`web/api`、`edge_agent`。
- 工具链：`uv` 管理依赖；`ruff`/`pytest` 用于质量控制。
- 数据与训练雏形：已有最小数据集配置（`data/data.yaml`）与训练脚本（`scripts/train.py`），并产出训练权重（如 `runs/train/exp/weights/best.pt`）。
- API 与测试：已完成 `/api/v1/health` 与 `/api/v1/inference/image` 闭环，并有较完整测试（具体以 `docs/progress.md` 为准）。

### 4.2 主要差距

- 数据与训练：需要补齐“可复现的数据切分/规模化数据集/评估报告（mAP/PR）”等，避免仅停留在最小样例。
- 推理：需要补齐性能基准、更多异常路径与后端一致性验证（例如导出后端与 PyTorch 后端输出对齐）。
- 边缘 Agent：需要端到端跑通采集 → 推理 → 上报（含离线缓存）。
- 生产化：容器化、观测性、CI/CD 仍需体系化落地。

---

## 5. 总体架构（目标形态）

### 5.1 模块边界

- `core/`：推理引擎 + 预处理/后处理（对上层提供稳定接口）。
- `web/api/`：HTTP API（鉴权/限流可后置，先把推理接口与错误码规范化）。
- `edge_agent/`：边缘侧编排（数据源、推理调用、结果上报、缓存与重试）。

### 5.2 关键接口约定

- **推理输入**：文件路径 / bytes / ndarray（内部统一为 ndarray）。
- **推理输出**：统一 schema（bbox/score/label；可扩展 mask/keypoints）。
- **可观测信息**：每次推理至少产出耗时、模型版本、输入尺寸、结果数量。

---

## 6. 里程碑与交付物（12 周）

> 时间仅为建议节奏；实际以数据准备与硬件条件为约束。

### M1（第 1-2 周）：MVP 闭环打通

**目标**：数据/训练/推理/API 四件套跑通，交付端到端 demo。

**交付物**：

- 数据与训练：
  - `data/` 目录规范、`data.yaml`、类目定义与标注规范（最小可用版）。
  - `scripts/train.py`（或等价命令文档）可复现训练；产出训练权重（默认形态：`runs/train/exp/weights/best.pt`；如需发布可复制到 `models/best.pt`）。
  - （待实现）导出 ONNX：补齐导出入口脚本/命令与 smoke test（目标产物：`models/best.onnx`）。
- 推理引擎（Python 基线）：
  - 支持图片输入（path/bytes/ndarray）；阈值可配置；结果映射到 schema。
  - 基础性能策略：模型缓存/预热；线程安全（或明确单进程单实例策略）。
- Web API：
  - `GET /api/v1/health`：返回版本与模型状态。
  - `POST /api/v1/inference/image`：上传图片并返回检测结果 JSON。
- 测试：
  - 单元测试覆盖推理输出 schema、异常路径；API 集成测试覆盖健康检查与上传推理。

**验收标准**：

- 本地可用 `uv` 复现：安装依赖 → 启动 API → 上传样例图片 → 返回结构化结果。
- `ruff` 无错误；`pytest` 通过；核心路径覆盖率目标 ≥ 60%。

### M2（第 3-4 周）：性能与可视化

**目标**：将推理后端与可视化/批量能力补齐，形成可演示的结果展示。

**交付物**：

- ONNX Runtime 推理路径（CPU/GPU 视平台而定），并与 Python 基线对齐输出。
- 性能基准脚本（单张、批量、不同输入尺寸），输出吞吐/延迟报告。
- 可视化：输出带框图片（API 可提供可选返回，或生成文件/bytes）。
- （规划）前端：先以最小页面验证上传与展示链路（若前端不在本仓库，可只保留接口契约）。

**验收标准**：

- 同一输入在不同后端输出 schema 一致；性能报告可复现。

### M3（第 5-8 周）：生产化与边缘 Agent

**目标**：让系统具备“部署、运行、观测、回滚”的基本生产能力，并落地边缘 Agent。

**交付物**：

- 边缘 Agent（Python 版）：
  - 数据源：RTSP/本地视频/图片目录至少支持一种。
  - 上报：HTTP（优先）或 MQTT（二选一）；失败重试与离线缓存。
  - 配置：YAML/ENV（与 `Settings` 体系一致）。
- 工程化：
  - CI（lint + test）；Dockerfile（API 服务镜像）；基础发布说明。
  - 观测性：请求/推理耗时日志；简单 metrics（Prometheus 友好格式或日志采集约定）。
- 模型与配置版本：
  - 模型命名/版本策略（如 `best-v{n}.onnx` + 元信息）。

**验收标准**：

- 在目标边缘设备或等价环境中可稳定运行，断网/失败可恢复；关键指标可采集。

### M4（第 9-12 周）：Rust/加速与稳态运营

**目标**：把“性能瓶颈”路径迁移到 Rust 或更高性能后端，提升边缘侧体验并稳定运营。

**交付物**：

- PyO3 预处理/后处理加速模块（以基准为导向，先做收益最大的环节）。
- （可选）独立 Rust 边缘 Agent 或 Rust 推理后端（ORT/TensorRT 视平台）。
- 运维能力：灰度发布、模型回滚、集中日志/告警策略（最小可用版）。

**验收标准**：

- 关键链路性能提升有量化对比；回滚/灰度流程可演练。

---

## 7. 工作分解（WBS）

### 7.1 数据与训练

- 类目与标注规范：定义 label 集、边界框规则、难例策略。
- 数据组织：`data/raw`、`data/labels`、`data/splits`；训练/验证/测试切分可复现。
- 训练脚本：超参、日志、权重输出路径、随机种子固定。
- 评估：mAP/precision/recall；对关键类别建立验收集。
- 导出：ONNX 导出与简要校验（输入输出形状、推理 smoke test）。

### 7.2 推理与预处理

- 输入适配：path/bytes/ndarray → ndarray；颜色空间/尺寸检查/letterbox。
- 输出映射：YOLO 输出 → `DetectionBox`（bbox/score/label）；异常与空结果策略。
- 配置：阈值、设备、模型路径；支持 `.env` 与默认值。
- 性能：模型缓存、预热、批量推理接口；并发策略明确。

### 7.3 Web API

- 路由：健康检查、图片推理；错误码与错误响应结构统一。
- 文档：OpenAPI 结构清晰；示例请求/响应。
- 安全（后置）：鉴权/限流/审计日志（M3 进入）。

### 7.4 边缘 Agent

- 采集：视频帧抽取策略（帧率/抽帧/分辨率）。
- 编排：推理队列与背压；本地缓存与批量上报。
- 可靠性：失败重试、断网缓存、健康自检与自恢复。

### 7.5 工程化与发布

- 质量门槛：`ruff` + `pytest`；（可选）类型检查：若引入 `mypy`，需保证 CI 可跑通。
- 版本：语义化版本或日期版本；模型版本与代码版本的对应关系。
- 容器化：API 镜像构建；运行参数通过环境变量注入，禁止硬编码密钥。

---

## 8. 质量与验收（统一口径）

- **Definition of Done（DoD）**：代码 + 测试 + 文档（至少更新 `docs/progress.md` 进度与关键决策）。
- **测试策略**：核心逻辑以单测为主，API 以集成测试为主；优先覆盖异常路径。
- **性能基线**：至少记录单张推理延迟与吞吐；对比不同后端与输入尺寸。

---

## 9. 风险与依赖

- **数据风险**：类别定义不稳定、标注质量波动 → 通过标注规范与抽检机制缓解。
- **平台差异**：macOS/Windows 与 Linux/Jetson 推理后端差异 → 后端选择策略与回退路径。
- **加速路线不确定**：TensorRT/ORT GPU 受环境影响 → 以 Python 基线兜底，性能优化放到 M2+。
- **工程范围膨胀**：前端/设备管理容易失控 → 以接口契约与最小可用 demo 控制范围。

---

## 10. 文档与协作约定

- 本文件是“计划”；`docs/progress.md` 是“进度与运行指南（含阶段性日志整合）”。
- 对外说明以根目录 README 为准；README 的结构与本计划应保持一致（必要时再同步更新）。

---

## 11. 按周执行计划（Week 1-12）

> 说明：每周都应满足最小 DoD：代码可运行、核心路径有测试、`ruff`/`pytest` 通过、并在 `docs/progress.md` 记录本周变更与结论。

### 前 10 天（日粒度，优先把 demo 做出来）

> 原则：先把“可演示闭环”跑通（即使先用 stub/占位模型），再逐步用真实训练模型替换。

**Day 1（对齐契约）**

- 目标：把 demo 所需接口与输出契约定死，避免后续返工。
- 任务：
  - 明确 `DetectionBox` 的坐标系（推荐：像素坐标 `xyxy`）、label 映射、score 口径。
  - 明确 API 成功/失败响应结构（错误码、消息、detail）。
- DoD：写入本计划/`docs/progress.md`，并确保 API OpenAPI 能呈现示例。

**Day 2（推理 Stub 打通）**

- 目标：不依赖真实模型，也能跑通“输入 → 输出 schema”。
- 任务：
  - 提供一个 stub 引擎：对任意图片返回固定/可控的检测结果。
  - 覆盖：空结果、异常（模拟模型未加载）。
- DoD：stub 有单测；API 可在无模型情况下演示。

**Day 3（API 上传闭环）**

- 目标：`POST /api/v1/inference/image` 完整可用。
- 任务：
  - 文件上传校验（空文件、非图片、过大等按最简规则处理）。
  - 统一错误响应。
- DoD：API 集成测试覆盖健康检查与上传推理（基于 stub）。

**Day 4（可视化最小能力）**

- 目标：demo 能看到“框画出来”。
- 任务：
  - 实现绘制 bbox 的工具函数（输入原图 + 检测结果 → 输出图片 bytes/文件）。
  - API 可选返回可视化结果（或提供单独的 debug 输出）。
- DoD：同一检测结果下，JSON 与可视化一致；可通过 API 或脚本稳定复现输出带框图。

**Day 5（端到端 Demo Day）**

- 目标：对外可演示：启动服务 → 上传图片 → 返回 JSON + 可视化带框图。
- 任务：
  - 写清楚 demo 步骤（命令、示例请求）。
  - 补齐关键错误路径（模型缺失、依赖缺失等）的返回行为。
- DoD：在干净环境复现 demo（至少本机新 venv/`uv sync`），且输出包含可视化带框图。

**Day 6（类目与标注口径定稿）**

- 目标：为训练做准备。
- 任务：类目列表、标注规则、样例图与难例策略。
- DoD：类目/口径冻结（后续变更需记录）。

**Day 7（数据目录与 data.yaml）**

- 目标：数据可复现组织。
- 任务：确定 `data/` 布局、切分规则，产出 `data.yaml`。
- DoD：用一份小数据集验证 `data.yaml` 可被训练脚本读取。

**Day 8（训练脚本跑通）**

- 目标：能训出一个 `best.pt`（不追求精度）。
- 任务：训练脚本/命令固定；输出路径与随机种子明确。
- DoD：训练日志与权重产物可复现。

**Day 9（真实模型接入推理）**

- 目标：用真实 YOLO 输出替换 stub。
- 任务：YOLO 输出解析 → schema；与 stub 输出字段完全一致。
- DoD：API 在真实模型与 stub 间可切换（通过配置/依赖注入）。

**Day 10（回归与收敛）**

- 目标：稳定性与测试补齐。
- 任务：补齐异常路径与边界条件测试；整理进度记录。
- DoD：`ruff`/`pytest` 全绿，且 demo 不依赖临时手工步骤。

### Week 1：先交付 Demo（API + Stub 推理 + 可视化）

**目标**：尽快做出可演示闭环：上传图片 → 返回结构化结果 + 可视化带框图（Week 1 必选）。

**任务**：

- 契约优先：冻结推理输出 schema（bbox 坐标系、label 映射、score 口径）与错误响应结构。
- 推理 stub：实现不依赖真实模型也能演示的推理输出（并提供空结果/异常模拟）。
- API：完善 `/api/v1/health` 与 `/api/v1/inference/image` 的成功与失败路径。
- 可视化：提供最小“画框”能力（用于 demo）。
- 测试：以 API 集成测试为主，覆盖健康检查与上传推理（基于 stub）。

**DoD / 验收**：

- 本地 `uv` 安装依赖 → 启动 API → 上传图片 → 返回结构化 JSON + 可视化带框图。
- `pytest` 全绿；demo 不依赖“手动改代码”。

### Week 2：接入真实模型（训练 → 推理 → 替换 stub）

**目标**：有真实 `best.pt` 并接入推理引擎；保持 API 契约不变。

**任务**：

- 类目与标注规范：输出“类目列表 + 标注规则 + 负样本/难例策略”，并冻结。
- 数据组织：确定 `data/` 目录布局与切分方式（train/val/test），产出 `data.yaml`。
- 训练入口：确定训练脚本/命令，能稳定产出 `models/best.pt`。
- 推理引擎：将 YOLO 输出解析并映射到 schema；确保与 Week1 stub 字段一致。
- 可靠性：补齐“模型缺失/依赖缺失/空文件/非图片”等错误路径测试。

**DoD / 验收**：

- 使用真实模型时，API 返回仍满足 Week1 的 schema 契约。
- `pytest` 全绿；核心路径覆盖率达到 M1 目标（≥ 60%）。

### Week 3：ONNX 导出与一致性校验

**目标**：产出 ONNX 模型并能 smoke test；明确输出一致性策略。

**任务**：

- 导出脚本：将训练权重导出 ONNX（并记录 opset/动态 shape 策略）。
- 一致性：对同一张样例图比较 Python 基线与 ONNX 结果差异（允许数值误差，要求 schema 一致）。
- 失败处理：导出/加载失败时错误信息清晰。

**DoD / 验收**：

- `models/best.onnx` 可在本机完成一次推理 smoke test（无论 CPU/GPU）。
- 形成“后端一致性校验”最小脚本/流程说明。

### Week 4：性能基准与可视化输出

**目标**：建立可复现基准；推理结果可视化（带框图）。

**任务**：

- 基准：单张/批量、不同输入尺寸基准，输出延迟/吞吐（记录机器信息）。
- 可视化：提供将检测结果绘制到图片的输出能力（返回 bytes 或文件）。

**DoD / 验收**：

- 基准结果可复现（至少同机重复运行稳定）。
- 可视化输出与 JSON 结果一致。

### Week 5：边缘 Agent 形态确定（最小链路）

**目标**：选择一个数据源 + 一种上报方式，跑通最小 Agent 循环。

**任务**：

- 数据源（二选一优先级）：图片目录轮询 > 本地视频 > RTSP。
- 上报方式：HTTP 优先；定义上报 payload（复用 API schema）。
- 配置：确定 YAML/ENV 的最小字段集合，与 `Settings` 对齐。

**DoD / 验收**：

- Agent 可启动并持续运行；能产生推理结果并成功上报（或写入本地缓存）。

### Week 6：Agent 可靠性（断网可用）

**目标**：离线缓存 + 重试 + 背压，保证边缘侧稳态运行。

**任务**：

- 缓存：失败结果落盘（队列/文件夹/SQLite 三选一，优先最简单）。
- 重试：指数退避/最大重试次数；成功后清理。
- 背压：推理队列与上报队列分离，避免“上报慢拖垮推理”。

**DoD / 验收**：

- 人为断网 10 分钟后恢复网络：缓存可回放，上报恢复正常，Agent 不崩溃。

### Week 7：CI 与容器化（最小可部署）

**目标**：API 服务可 Docker 构建；CI 自动跑 lint + test。

**任务**：

- CI：配置最小流水线（ruff + pytest）。
- Dockerfile：构建 API 服务镜像；运行参数全部通过 env 注入。

**DoD / 验收**：

- CI 在主分支每次 push 可通过。
- `docker build` 与容器启动说明可复现。

### Week 8：观测性与版本策略

**目标**：能看到关键指标；模型与配置版本可追踪。

**任务**：

- 观测：统一记录 request_id、推理耗时、模型版本、结果数量。
- 版本：制定模型版本命名/元信息（最少：版本号、训练数据摘要、导出参数）。

**DoD / 验收**：

- 能从日志中定位一次推理请求的全链路耗时与使用的模型版本。

### Week 9：Rust/PyO3 候选点确认（以基准驱动）

**目标**：不盲目 Rust：先定位瓶颈再决定做哪个模块。

**任务**：

- Profiling：用 Week4 基准定位最耗时的环节（预处理/后处理/模型推理）。
- 选点：明确“做 Rust 能带来多少收益”的假设与验证方法。

**DoD / 验收**：

- 输出一个“瓶颈点 → 预期收益 → 验证方式”的决策记录。

### Week 10：PyO3 加速 PoC

**目标**：完成一个可替换的 Rust 模块 PoC，并与 Python 输出一致。

**任务**：

- 选择一个环节（优先：预处理 letterbox/resize 或后处理 NMS）。
- 对齐：输入输出与 Python 实现严格一致；加基准对比。

**DoD / 验收**：

- 在同一基准集上对比：正确性一致 + 性能提升可量化。

### Week 11：边缘侧稳态运营能力（灰度/回滚最小版）

**目标**：把“换模型/回滚模型”的流程跑通。

**任务**：

- 模型发布：定义模型包结构与下载/校验方式（hash 校验即可）。
- 回滚：失败自动回退到上一个可用模型。

**DoD / 验收**：

- 模拟发布一个坏模型：Agent/服务可自动回滚并恢复。

### Week 12：试点交付与演练

**目标**：完成试点演示与文档收敛。

**任务**：

- 演示脚本：准备样例数据、演示步骤、常见故障处理。
- 文档收敛：补齐部署/运行/排障的最小说明（不追求完美，追求可用）。

**DoD / 验收**：

- 在干净环境复现：安装/部署 → 运行 → 演示 → 排障。

---

## 12. 关键产出物清单（落地到“文件/接口/脚本”）

> 下列条目是建议落地形态；具体文件名可按项目实际情况调整，但应保证“可复现、可查找”。

### 12.1 数据与模型

- `data/data.yaml`：数据集配置与类目定义。
- `models/`：
  - `best.pt`（训练产物）
  - `best.onnx`（导出产物）
  - `models/metadata.json`（建议）：记录版本、数据摘要、导出参数。

### 12.2 脚本

- `scripts/train.py`：训练入口（记录超参与输出目录）。
- （待实现）导出入口（ONNX）：可用 `scripts/export.py` 或等价命令，需明确输入/输出与验证方式。
- `scripts/benchmark.py`（建议）：基准测试入口。

### 12.3 API 契约

- OpenAPI：/health 与 /inference/image 的请求/响应示例齐全。
- 错误响应：统一结构（错误码、消息、可选 detail）。

### 12.4 边缘 Agent

- `edge_agent` 配置样例（建议：`config/edge_config.yaml`）。
- 离线缓存目录与数据格式约定（文件名/内容结构）。

---

## 13. 关键决策点（需要尽早定下来，避免返工）

1. **缺陷类目与标注口径**：类目是否稳定？边界框规则是否统一？（Week 1 必须定）
2. **推理输出 schema**：bbox 坐标系与单位（xyxy/xywh、像素/归一化）、label 映射、score 口径（Week 1 必须定）
3. **边缘上报协议**：HTTP or MQTT（二选一先跑通，Week 5 定）
4. **模型版本策略**：模型与代码如何关联、如何回滚（Week 8 定）
5. **Rust 选点**：以基准驱动，不做“为了 Rust 而 Rust”（Week 9 定）
